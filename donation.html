<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8">
    <meta content="IE=edge" http-equiv="X-UA-Compatible">
    <meta content="width=device-width, initial-scale=1, shrink-to-fit=no" name="viewport">
    <meta content="" name="description">
    <meta content="" name="author">

    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.4.0/jquery.min.js"></script>

    <title>Donate</title>

    <!-- Custom fonts for this template-->
    <link href="js/fontawesome-free/css/all.min.css" rel="stylesheet" type="text/css">

    <!-- Custom styles for this template-->
    <link href="css/profile_page.css" rel="stylesheet">

    <title>Donations</title>
    <style>
        #other {
            width: 100%;
        }
        #nextPage {
            margin-top: 10%;
            width: 100%;
        }
    </style>
</head>

<body id="page-top">

<nav class="navbar navbar-expand navbar-dark bg-dark static-top">

    <a class="navbar-brand mr-1" href="profile.html"></a>

    <button class="btn btn-link btn-sm text-white order-1 order-sm-0" href="#" id="sidebarToggle">
        <i class="fas fa-bars"></i>
    </button>

</nav>


<div id="wrapper">

    <!-- Sidebar -->
    <ul class="sidebar navbar-nav">
        <li class="nav-item">
            <a class="nav-link" href="index.html">
                <i class="fas fa-user-circle fa-fw"></i>
                <span>Profile</span>
            </a>
        </li>
        <li class="nav-item dropdown">
            <a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" id="pagesDropdown" role="button">
                <i class="fas fa-fw fa-folder"></i>
                <span>Tools</span>
            </a>
            <div aria-labelledby="pagesDropdown" class="dropdown-menu">
                <h6 class="dropdown-header">Options:</h6>
                <a class="dropdown-item active" href="querymenu.html">Search & Query Menu</a>
            </div>
        </li>
        <li class="nav-item dropdown">
            <a aria-expanded="false" aria-haspopup="true" class="nav-link dropdown-toggle" data-toggle="dropdown" href="#" id="pagesDropdown" role="button">
                <i class="fas fa-fw fa-sign-out-alt"></i>
                <span>Account Options</span>
            </a>
            <div aria-labelledby="pagesDropdown" class="dropdown-menu">

                <h6 class="dropdown-header">Login Screens:</h6>
                <a class="dropdown-item" href="login.html">Login</a>
                <a class="dropdown-item" href="register.html">Register</a>
                <a class="dropdown-item" href="forgot-password.html">Forgot Password</a>
            </div>
        </li>

    </ul>

    <div id="content-wrapper">

        <div class="container-fluid">

            <!-- Breadcrumbs-->
            <ol class="breadcrumb">
                <li class="breadcrumb-item">
                    <a href="./index.html">Home</a>
                </li>
                <li class="breadcrumb-item active">Donations</li>
            </ol>

            <!-- Page Content -->
            <h1 id="title">Donate Now</h1>
            <hr>
            <!--  First Page, Select Donation Amount  -->
            <div class="container col-sm-4" id="donation_amount">
                <h4>Select Contribution</h4>
                <!--  One of the Amounts should be pre-selected  -->

                <select id="currency">
                </select><br>
                <input type="button" class="bg-light" value="5" name="five" onclick="getAmount(this)">
                <input type="button" class="bg-light" value="10" name="ten" onclick="getAmount(this)" autofocus>
                <input type="button" class="bg-light" value="15" name="fifteen" onclick="getAmount(this)"><br>
                <input type="button" class="bg-light" value="25" name="twenty_five" onclick="getAmount(this)">
                <input type="button" class="bg-light" value="50" name="fifty" onclick="getAmount(this)">
                <input type="button" class="bg-light" value="100" name="hundred" onclick="getAmount(this)"><br>
                <!--  Provides User ability to specify amount to donate  -->
                <input type="text" pattern="\d*" placeholder="Other" class="bg-light" name="other" id="other" onchange="getAmount(this)">
                <button class="bg-info" id="nextPage">Donate</button>



            </div>
            <div class="container col-sm-4" id="payment" style="display:none">
                <div class="container">
                    <div id="app">
                        <div id="firebaseui-auth-container"></div>
                        <div id="loader">&hellip;</div>
                        <div v-if="currentUser">
                            <h2>Hello {{ currentUser.email }},</h2>
                            <button v-on:click="signOut">Sign out</button>
                            <div v-if="stripeCustomerInitialized">
                                <h3>Credit Cards</h3>
                                <ul>
                                    <li v-for="source in sources">
                                        <span v-if="source.id">
                                          {{ source.brand }} &hellip;{{ source.last4 }}
                                          (exp. {{ source.exp_month }}/{{ source.exp_year }})
                                        </span>
                                        <span v-else>&hellip;</span>
                                    </li>
                                </ul>
                                <div>
                                    <h4>New</h4>
                                    <div>
                                        <label>
                                            Number <input v-model="newCreditCard.number">
                                        </label>
                                    </div>
                                    <div>
                                        <label>
                                            CCV <input v-model="newCreditCard.cvc">
                                        </label>
                                    </div>
                                    <div>
                                        <label>
                                            Exp
                                            <input v-model="newCreditCard.exp_month" size="2"> /
                                            <input v-model="newCreditCard.exp_year" size="4">
                                        </label>
                                    </div>
                                    <div>
                                        <label>
                                            Zip <input v-model="newCreditCard.address_zip">
                                        </label>
                                    </div>
                                    <div>
                                        <button v-on:click="submitNewCreditCard">Add</button>
                                        {{ newCreditCard.error }}
                                    </div>
                                </div>
                                <h3>Charges</h3>
                                <ul>
                                    <li v-for="(charge, id) in charges">
                                        {{ charge.amount }}
                                        <span v-if="charge.error">
                                          {{ charge.error }}
                                        </span>
                                        <span v-else-if="charge.outcome">
                                          {{ charge.outcome.seller_message }}
                                          {{ charge.source.brand }} &hellip;{{ charge.source.last4 }}
                                          (exp. {{ charge.source.exp_month }}/{{ charge.source.exp_year }})
                                        </span>
                                        <span v-else>&hellip;</span>
                                    </li>
                                </ul>
                                <h4>New</h4>
                                <div>
                                    <label>
                                        Card
                                        <select v-model="newCharge.source">
                                            <option :value="null">Default payment method</option>
                                            <option v-for="(source, id) in sources" v-bind:value="source.id" v-if="source.id">
                                                {{ source.brand }} &hellip;{{ source.last4 }}
                                                (exp. {{ source.exp_month }}/{{ source.exp_year }})
                                            </option>
                                        </select>
                                    </label>
                                </div>
                                <div>
                                    <label>
                                        Amount <input v-model="newCharge.amount" id="amount">
                                    </label>
                                </div>
                                <div>
                                    <button v-on:click="submitNewCharge">Charge</button>
                                    {{ newCharge.error }}
                                </div>
                            </div>
                            <div v-else>&hellip;</div>
                        </div>
                    </div>
                </div>


            </div>


            <script>

                let amount = 10;
                function getAmount(objButton){
                    amount = objButton.value;
                    console.log(amount);
                }

                // Update page after clicking "Donate"
                $('#nextPage').on('click', function(){
                    $('#donation_amount').hide();
                    $('#title').html("Payment");
                    let link = document.createElement("li");
                    let olds = document.getElementsByClassName("breadcrumb-item");
                    olds[1].innerHTML = "<a href='./donation.html'>Donations</a>";
                    link.className = "breadcrumb-item active";
                    link.innerHTML = "Payment";
                    let bread = $('.breadcrumb');
                    bread[0].appendChild(link);
                    $('#payment').show();
                    $('#place_amount').html("Donating: " + amount);
                    $('#selected_currency').html("Currency: " + selected_currency);
                    console.log(amount);
                });

                // Dynamically add currency selections with their exchange rates compared to CAD
                let currencies = document.getElementById("currency");
                let selected_currency = "CAD";
                $.getJSON('https://api.exchangeratesapi.io/latest?base=CAD', function(data) {
                    let ratesObj = data.rates;
                    console.log(ratesObj);
                    for(let key in ratesObj){
                        let option = document.createElement("option");
                        option.value = ratesObj[key];
                        option.innerHTML = key;
                        option.label = key;
                        if(key === "CAD"){
                            option.selected = true;
                        }
                        currencies.appendChild(option);
                    }
                });

                // Update donation amount according to currency
                currencies.addEventListener('change', function(){
                    for(let i = 0; i < 6; i++){
                        let amounts = [5, 10, 15, 25, 50, 100];
                        $('.bg-light')[i].value = Math.round(amounts[i]*this.value);
                        console.log($('.bg-light')[i].value);
                    }
                    let options = this.children;
                    for(let i in options){
                        if(options[i].selected){
                            selected_currency = options[i].label;
                            console.log(selected_currency);
                        }
                    }
                    amount = Math.round(10*this.value);
                    console.log(this.value);
                }, false);

                let default_amount = document.getElementById("amount");
                default_amount.value = amount;
                Stripe.setPublishableKey( /* TODO: add your stripe publishable key */ );
                var firebaseUI = new firebaseui.auth.AuthUI(firebase.auth());
                var firebaseAuthOptions = {
                    callbacks: {
                        signInSuccess: (currentUser, credential, redirectUrl) => { return false; },
                        uiShown: () => { document.getElementById('loader').style.display = 'none'; }
                    },
                    signInFlow: 'popup',
                    signInSuccessUrl: '/',
                    signInOptions: [ firebase.auth.GoogleAuthProvider.PROVIDER_ID ],
                    tosUrl: '/'
                };
                firebase.auth().onAuthStateChanged(firebaseUser => {
                    if (firebaseUser) {
                        document.getElementById('loader').style.display = 'none';
                        app.currentUser = firebaseUser;
                        app.listen();
                    } else {
                        firebaseUI.start('#firebaseui-auth-container', firebaseAuthOptions);
                        app.currentUser = null;
                    }
                });
                var app = new Vue({
                    el: '#app',
                    data: {
                        currentUser: null,
                        sources: {},
                        stripeCustomerInitialized: false,
                        newCreditCard: {
                            number: '4242424242424242',
                            cvc: '111',
                            exp_month: 1,
                            exp_year: 2020,
                            address_zip: '00000'
                        },
                        charges: {},
                        newCharge: {
                            source: null,
                            amount: 2000
                        }
                    },
                    ready: () => {
                    },
                    methods: {
                        listen: function() {
                            firebase.firestore().collection('stripe_customers').doc(`${this.currentUser.uid}`).onSnapshot(snapshot => {
                                this.stripeCustomerInitialized = (snapshot.data() !== null);
                            }, () => {
                                this.stripeCustomerInitialized = false;
                            });
                            firebase.firestore().collection('stripe_customers').doc(`${this.currentUser.uid}`).collection('sources').onSnapshot(snapshot => {
                                let newSources = {};
                                snapshot.forEach(doc => {
                                    const id = doc.id;
                                    newSources[id] = doc.data();
                                })
                                this.sources = newSources;
                            }, () => {
                                this.sources = {};
                            });
                            firebase.firestore().collection('stripe_customers').doc(`${this.currentUser.uid}`).collection('charges').onSnapshot(snapshot => {
                                let newCharges = {};
                                snapshot.forEach(doc => {
                                    const id = doc.id;
                                    newCharges[id] = doc.data();
                                })
                                this.charges = newCharges;
                            }, () => {
                                this.charges = {};
                            });
                        },
                        submitNewCreditCard: function() {
                            Stripe.card.createToken({
                                number: this.newCreditCard.number,
                                cvc: this.newCreditCard.cvc,
                                exp_month: this.newCreditCard.exp_month,
                                exp_year: this.newCreditCard.exp_year,
                                address_zip: this.newCreditCard.address_zip
                            }, (status, response) => {
                                if (response.error) {
                                    this.newCreditCard.error = response.error.message;
                                } else {
                                    firebase.firestore().collection('stripe_customers').doc(this.currentUser.uid).collection('tokens').add({token: response.id}).then(() => {
                                        this.newCreditCard = {
                                            number: '',
                                            cvc: '',
                                            exp_month: 1,
                                            exp_year: 2017,
                                            address_zip: ''
                                        };
                                    });
                                }
                            });
                        },
                        submitNewCharge: function() {
                            firebase.firestore().collection('stripe_customers').doc(this.currentUser.uid).collection('charges').add({
                                source: this.newCharge.source,
                                amount: parseInt(this.newCharge.amount)
                            });
                        },
                        signOut: function() {
                            firebase.auth().signOut()
                        }
                    }
                });
                // Save the value of selected button
                // Event Listener for button click
            </script>
            <!-- Import and configure the Firebase SDK -->
            <!-- These scripts are made available when the app is served or deployed on Firebase Hosting -->
            <!-- If you do not serve/host your project using Firebase Hosting see https://firebase.google.com/docs/web/setup -->
            <script src="/__/firebase/5.9.1/firebase-app.js"></script>
            <script src="/__/firebase/5.9.1/firebase-auth.js"></script>
            <script src="/__/firebase/5.9.1/firebase-firestore.js"></script>
            <script src="/__/firebase/init.js"></script>

            <!-- Import Firebase UI -->
            <script src="https://cdn.firebase.com/libs/firebaseui/3.5.2/firebaseui.js"></script>

        </div>
        <!-- /.container-fluid -->


        <!-- Sticky Footer -->
        <footer class="sticky-footer">
            <div class="container my-auto">
                <div class="copyright text-center my-auto">
                    <span>Copyright © Project Treehouse 2019</span>
                </div>
            </div>
        </footer>

    </div>
    <!-- /.content-wrapper -->

</div>
<!-- /#wrapper -->

<!-- Scroll to Top Button-->
<a class="scroll-to-top rounded" href="#page-top">
    <i class="fas fa-angle-up"></i>
</a>

<!-- Logout Modal-->
<div aria-hidden="true" aria-labelledby="exampleModalLabel" class="modal fade" id="logoutModal" role="dialog" tabindex="-1">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="exampleModalLabel">Ready to Leave?</h5>
                <button aria-label="Close" class="close" data-dismiss="modal" type="button">
                    <span aria-hidden="true">×</span>
                </button>
            </div>
            <div class="modal-body">Select "Logout" below if you are ready to end your current session.</div>
            <div class="modal-footer">
                <button class="btn btn-secondary" data-dismiss="modal" type="button">Cancel</button>
                <a class="btn btn-primary" href="login.html">Logout</a>
            </div>
        </div>
    </div>
</div>

<!-- Bootstrap core JavaScript-->
<script src="js/jquery/jquery.min.js"></script>
<!--<script src="js/bootstrap/js/bootstrap.bundle.min.js"></script>-->

<!-- Core plugin JavaScript-->
<script src="js/jquery-easing/jquery.easing.js"></script>

<!-- Custom scripts for all pages-->
<!--<script src="js/profile_page.min.js"></script>-->

</body>
</html>